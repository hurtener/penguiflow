import { getContext, setContext } from 'svelte';
import type { ArtifactRef, ArtifactStoredEvent } from '$lib/types';

const ARTIFACTS_STORE_KEY = Symbol('artifacts-store');

/**
 * Creates a reactive store for managing artifacts.
 * Artifacts are session-scoped downloadable files generated by tools.
 */
export interface ArtifactsStore {
  readonly artifacts: Map<string, ArtifactRef>;
  readonly list: ArtifactRef[];
  readonly count: number;
  has(id: string): boolean;
  get(id: string): ArtifactRef | undefined;
  addArtifact(event: ArtifactStoredEvent): void;
  remove(id: string): boolean;
  clear(): void;
}

export function createArtifactsStore(): ArtifactsStore {
  let artifacts = $state<Map<string, ArtifactRef>>(new Map());

  return {
    /** Get the raw artifacts map */
    get artifacts() { return artifacts; },

    /** Get artifacts as an array (for iteration) */
    get list() { return Array.from(artifacts.values()); },

    /** Get the total count of artifacts */
    get count() { return artifacts.size; },

    /**
     * Check if an artifact exists by ID
     */
    has(id: string): boolean {
      return artifacts.has(id);
    },

    /**
     * Get a specific artifact by ID
     */
    get(id: string): ArtifactRef | undefined {
      return artifacts.get(id);
    },

    /**
     * Add an artifact from an SSE event.
     * If artifact with same ID exists, it will be updated.
     */
    addArtifact(event: ArtifactStoredEvent): void {
      const ref: ArtifactRef = {
        id: event.artifact_id,
        mime_type: event.mime_type,
        size_bytes: event.size_bytes,
        filename: event.filename,
        sha256: null,
        source: event.source
      };
      // Create new Map to trigger reactivity
      const newMap = new Map(artifacts);
      newMap.set(event.artifact_id, ref);
      artifacts = newMap;
    },

    /**
     * Remove an artifact by ID.
     * Returns true if artifact was removed, false if it didn't exist.
     */
    remove(id: string): boolean {
      if (!artifacts.has(id)) {
        return false;
      }
      const newMap = new Map(artifacts);
      newMap.delete(id);
      artifacts = newMap;
      return true;
    },

    /**
     * Clear all artifacts.
     * Called when session is reset.
     */
    clear(): void {
      artifacts = new Map();
    }
  };
}

export function setArtifactsStore(store: ArtifactsStore = createArtifactsStore()): ArtifactsStore {
  setContext(ARTIFACTS_STORE_KEY, store);
  return store;
}

export function getArtifactsStore(): ArtifactsStore {
  return getContext<ArtifactsStore>(ARTIFACTS_STORE_KEY);
}

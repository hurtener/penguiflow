"""Integration tests for the {{ class_name }}Orchestrator."""

from __future__ import annotations

import pytest

from {{ package_name }}.config import Config
from {{ package_name }}.orchestrator import {{ class_name }}Orchestrator
from {{ package_name }}.clients.memory import MemoryClient


@pytest.fixture
def config() -> Config:
    return Config()


class TrackingMemory(MemoryClient):
    """Memory stub that records calls for assertions."""

    def __init__(self, base_url: str) -> None:
        super().__init__(base_url)
        self.calls: list[tuple[str, dict[str, str]]] = []

    async def start_session(self, **kwargs):  # type: ignore[override]
        self.calls.append(("start_session", kwargs))
        return await super().start_session(**kwargs)

    async def auto_retrieve(self, **kwargs):  # type: ignore[override]
        self.calls.append(("auto_retrieve", kwargs))
        return await super().auto_retrieve(**kwargs)

    async def ingest_interaction(self, **kwargs):  # type: ignore[override]
        self.calls.append(("ingest_interaction", kwargs))
        return await super().ingest_interaction(**kwargs)


@pytest.mark.asyncio
async def test_execute_returns_agent_response(config: Config) -> None:
    orchestrator = {{ class_name }}Orchestrator(config)
    response = await orchestrator.execute(
        query="Ping?",
        tenant_id="t-1",
        user_id="u-1",
        session_id="s-1",
    )

    assert response.answer
    assert response.trace_id
    await orchestrator.stop()


@pytest.mark.asyncio
async def test_memory_lifecycle_called(config: Config) -> None:
    orchestrator = {{ class_name }}Orchestrator(config)
    tracker = TrackingMemory(config.memory_base_url)
    orchestrator._memory = tracker  # type: ignore[attr-defined]

    await orchestrator.execute(
        query="Check lifecycle",
        tenant_id="tenant-xyz",
        user_id="user-xyz",
        session_id="session-xyz",
    )

    assert [call[0] for call in tracker.calls] == [
        "start_session",
        "auto_retrieve",
        "ingest_interaction",
    ]
    await orchestrator.stop()


@pytest.mark.asyncio
async def test_stop_marks_orchestrator_inactive(config: Config) -> None:
    orchestrator = {{ class_name }}Orchestrator(config)
    assert orchestrator._started is True  # type: ignore[attr-defined]
    await orchestrator.stop()
    assert orchestrator._started is False  # type: ignore[attr-defined]

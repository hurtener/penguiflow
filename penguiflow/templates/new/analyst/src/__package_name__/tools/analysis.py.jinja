"""Analyst tools."""

from __future__ import annotations

from penguiflow.catalog import tool
from penguiflow.planner import ToolContext
{% if with_streaming %}
from ..telemetry import StatusUpdate
{% endif %}
from ..clients.analyst import AnalystClient
from ..models import AnalysisRequest, AnalysisResult


def _client(ctx: ToolContext) -> AnalystClient:
    """Resolve Analyst client from tool context."""
    base_url = ctx.tool_context.get("analyst_base_url", "http://localhost:9200")
    return AnalystClient(base_url)


@tool(desc="Perform analysis on behalf of another agent", tags=["analyst"])
async def analyze_request(args: AnalysisRequest, ctx: ToolContext) -> AnalysisResult:
    client = _client(ctx)
{% if with_streaming %}
    publisher = ctx.tool_context.get("status_publisher")
    if callable(publisher):
        publisher(StatusUpdate(status="thinking", message=f"Analyzing {args.topic}"))
    await ctx.emit_chunk("analysis", 0, f"Analyzing {args.topic}")
{% endif %}
    result = await client.analyze(args.topic, args.artifacts)
    return AnalysisResult(
        summary=str(result.get("summary", "")),
        recommendations=[str(rec) for rec in result.get("recommendations", [])],
    )
